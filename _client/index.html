<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Albedo Signer</title>

  <script defer src="https://unpkg.com/@albedo-link/intent/lib/albedo.intent.js"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <script>
    const { CLAIM_TOKEN, ENV } = getEnv()
    const isDev = ENV !== 'prod'
    const apiUrl = isDev ? 'https://api-dev.stellar.quest' : 'https://api.stellar.quest'

    async function albedoOpen(e, _claimToken, _xdr) {
      const url = new URL(location.href)

      const xdr = _xdr || url.searchParams.get('xdr')
      const pubkey = url.searchParams.get('pubkey')
      const network = url.searchParams.get('network')

      const claimToken = _claimToken || await CLAIM_TOKEN

      return albedo.tx({
        xdr,
        pubkey,
        network,
        description: 'Claim your Stellar Quest reward'
      })
      .then(({ signed_envelope_xdr }) =>
        fetch(`${apiUrl}/prize/claim`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${claimToken}`
          },
          body: JSON.stringify({
            innerTx: signed_envelope_xdr
          })
        })
        .then(async (res) => {
          if (res.ok)
            return
          else
            throw await res.json()
        })
      )
      .catch(async (err) => {
        let { claimToken } = err

        if (claimToken) {
          const { xdr } = JSON.parse(
            atob(
              claimToken.split('.')[1]
            )
          )
          
          return albedoOpen(null, claimToken, xdr)
        }

        else
          this.error = JSON.stringify(err, null, 2)
      })
    }

    function getEnv() {
      return fetch('/env')
      .then((res) => {
        if (res.ok)
          return res.json()
        else
          throw res
      })
      .catch((err) => console.error(err))
    }

    document.addEventListener("alpine:init", () => {
      Alpine.data("data", () => ({
        error: null
      }));
    });
  </script>
</head>

<body x-data="data">
  <button x-on:click="albedoOpen">Open Albedo</button>  
  <pre x-show="error" x-text="error"></pre>
</body>
</html>